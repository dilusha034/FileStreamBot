<!-- (මෙතන සිට Copy කරන්න) -->
<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POP Tv One | {{file_name}}</title>
    <link rel="icon" href="https://raw.githubusercontent.com/dilusha034/FileStreamBot/main/photo_2025-09-24_00-54-09.jpg?v=2" type="image/x-icon">
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/proavipatil/data@main/fs/src/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@500;700&display=swap" rel="stylesheet">
</head>
<body>
    <nav>
        <div class="nleft">
            <a href="#">
                <h3 id="heading" style="z-index: 100; visibility: hidden;" class="magnet title">POP Tv One</h3>
            </a>
        </div>
        <div class="nryt">
            <a class="home-btn magnet" href="#main">මුල් පිටුව</a>
            <a href="#abtus" class="about-btn magnet">අපි ගැන</a>
        </div>
    </nav>
    <div class="main" id="main">
        <video id="player" playsinline controls width="100%"></video>
        <div class="file-name">
            <h4>ගොනුවේ නම: {{file_name}}</h4>
            <h4>ගොනුවේ ප්‍රමාණය: {{file_size}}</h4>
        </div>
        <!-- නැතිවුණු Buttons ටික නැවතත් මෙතනට දාමු (ඒවාට අදාළ script එකත් එක්කම) -->
    </div>
    <!-- අනෙකුත් HTML කොටස් (About, Channels, etc.) මෙතනට දාන්න පුළුවන් -->
</body>

<script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>

<!-- === මෙන්න අපේ අලුත්ම, සුපිරිම බුද්ධිමත් Player Script එක === -->
<script>
document.addEventListener('DOMContentLoaded', async () => {
    const player = new Plyr('#player', { captions: { active: true, update: true, language: 'auto' } });
    const fileName = "{{file_name}}";
    const fileUrl = "{{file_url}}";
    const dbId = fileUrl.split('/').pop();

    const sources = {
        type: 'video',
        title: fileName,
        sources: [{ src: fileUrl, type: 'video/mp4' }],
        tracks: []
    };

    // MKV file එකක් නම් පමණක් server එකෙන් subtitle තොරතුරු ඉල්ලනවා
    if (fileName.toLowerCase().endsWith('.mkv')) {
        try {
            // 1. මුලින්ම server එකෙන් මේ වීඩියෝ එකේ තියෙන subtitles මොනවද කියලා අහනවා
            const response = await fetch(`/subtitles/info/${dbId}`);
            if (response.ok) {
                const subtitles = await response.json();
                
                // 2. ලැබෙන list එක অনুযায়ী player එකට tracks එකතු කරනවා
                subtitles.forEach((sub, i) => {
                    sources.tracks.push({
                        kind: 'subtitles',
                        label: sub.title || sub.lang,
                        srclang: sub.lang.slice(0, 2),
                        // 3. User select කළාම අදාළ track එක ඉල්ලන්න URL එක හදනවා
                        src: `/subtitle/${dbId}/${sub.index}`,
                        default: i === 0 // පළවෙනි එක default විදිහට on කරනවා
                    });
                });
            }
        } catch (error) {
            console.error("Subtitle තොරතුරු ලබාගැනීමට නොහැකි විය:", error);
        }
    }
    
    player.source = sources;
});
</script>

<!-- Title එක හංගලා පෙන්නන අපේ script එක (මේක අන්තිමටම තියන්න) -->
<script>
    window.addEventListener('load', function() {
        const heading = document.getElementById('heading');
        if (heading) {
            heading.textContent = 'POP Tv One';
            heading.style.visibility = 'visible';
        }
    });
</script>

</html>
<!-- (Copy කිරීම මෙතනින් අවසන්) -->
