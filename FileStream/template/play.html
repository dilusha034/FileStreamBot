<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POP Tv One | {{file_name}}</title>
    <link rel="icon" href="https://raw.githubusercontent.com/dilusha034/FileStreamBot/main/photo_2025-09-24_00-54-09.jpg?v=2" type="image/x-icon">
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/proavipatil/data@main/fs/src/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@500;700&display=swap" rel="stylesheet">
    
    <!-- Design-specific libraries, loaded here for structure -->
    <link rel="stylesheet" href="https://unpkg.com/sheryjs/dist/Shery.css" />
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <!-- Navigation and other design elements -->
    <nav>
        <div class="nleft"><a href="#"><h3 id="heading" class="magnet title">POP Tv One</h3></a></div>
        <div class="nryt"><a class="home-btn magnet" href="#main">මුල් පිටුව</a><a href="#abtus" class="about-btn magnet">අපි ගැන</a></div>
    </nav>
    <div class="outer">
        <div class="inner">
            <div class="main" id="main">
                <!-- Player and File Info -->
                <video id="player" playsinline controls data-filename="{{file_name}}" data-fileurl="{{dl_url}}"></video>
                <div class="file-name">
                    <h4 style="display: inline;">ගොනුවේ නම: </h4><p style="display: inline;">{{file_name}}</p><br>
                    <h4 style="display: inline;">ගොනුවේ ප්‍රමාණය: </h4><p style="display: inline;">{{file_size}}</p>
                </div>
                <div class="downloadBtn">
                     <a href="{{dl_url}}" target="_blank" class="magnet" rel="noopener noreferrer" download="{{file_name}}">
                        <button><img style="height: 30px;" src="https://i.ibb.co/RjzYttX/dl.png" alt=""> බාගත කරන්න</button>
                    </a>
                </div>
            </div>
            <!-- About section and other elements -->
            <div class="abt"><div class="about"><div class="about-dets"><div class="abt-sec" id="abtus" style="padding: 160px 30px;"><h1 style="text-align: center;">POP TV ONE වෙත <Span>සාදරයෙන්</Span> පිළිගනිමු</h1><p style="text-align: center; line-height: 2;word-spacing: 2px;  letter-spacing: 0.8px;">මෙය POP Tv One හි නිල චිත්‍රපට සහ කතා මාලා නැරඹීමේ පිටුවයි. ඔබට අවශ්‍ය නම් මෙතනින් කෙලින්ම නැරඹීමට හෝ බාගත කිරීමට හැකිය. <br><br>ඔබ මෙම සේවාවට කැමති නම්, ඔබේ මිතුරන් සමගද බෙදාගැනීමට අමතක කරන්න එපා!</p></div><div class="abt-sec" id="channels"><h1>අපේ <span>TELEGRAM</span> චැනල්</h1><div class="links chnl-link"><a class="magnet" href="https://t.me/POPTvOne"><button>POP TV ONE (Movies & TV)</button></a></div></div><div class="abt-sec" id="contact"><p style="text-align: center;">යම් ගැටළුවක් හෝ දෝෂයක් ඇත්නම්, පහතින් අපව අමතන්න</p><div class="links contact"><a href="https://t.me/Mr_D_2000"><button>සම්බන්ධ වන්න (Contact)</button></a></div></div></div></div></div>
        </div>
    </div>
    
    <!-- Player Library -->
    <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>

    <!-- Player Initialization Script (MUST BE AFTER PLYR LIBRARY) -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const videoElement = document.getElementById('player');
                if (!videoElement) return;

                const fileName = videoElement.getAttribute('data-filename');
                const fileUrl = videoElement.getAttribute('data-fileurl');
                if (!fileName || !fileUrl) return;

                const player = new Plyr(videoElement, {
                    captions: { active: true, update: true, language: 'auto' }
                });

                player.source = {
                    type: 'video',
                    title: fileName,
                    sources: [{ src: fileUrl }],
                };

                if (fileName.toLowerCase().endsWith('.mkv')) {
                    const pathParts = window.location.pathname.split('/');
                    const db_id = pathParts[pathParts.length - 1];
                    const response = await fetch(`/subtitles/${db_id}`);
                    
                    if (response.ok) {
                        const subtitleStreams = await response.json();
                        if (subtitleStreams && subtitleStreams.length > 0) {
                            const tracks = subtitleStreams
                                .filter(s => s.codec_type === 'subtitle')
                                .map(s => {
                                    const trackElement = document.createElement('track');
                                    trackElement.kind = 'subtitles';
                                    trackElement.label = s.tags?.title || s.tags?.language || `Track ${s.index}`;
                                    trackElement.srclang = s.tags?.language?.substring(0, 2) || 'zxx';
                                    trackElement.src = `/subtitle/${db_id}/${s.index}`;
                                    videoElement.appendChild(trackElement);
                                    return trackElement;
                                });
                            
                            if (tracks.length > 0) {
                                player.once('ready', () => {
                                   setTimeout(() => { 
                                       player.currentTrack = 0; 
                                       player.captions.enabled = true;
                                    }, 500);
                                });
                            }
                        }
                    }
                }
            } catch (error) {
                console.error("Player initialization failed:", error);
            }
        });
    </script>

    <!-- Design-specific libraries (MUST BE AT THE END) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.155.0/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/automat/controlkit.js@master/bin/controlKit.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sheryjs/dist/Shery.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/proavipatil/data@main/fs/src/script.js"></script>
</body>
</html>
