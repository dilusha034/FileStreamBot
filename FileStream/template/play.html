<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POP Tv One | {{file_name}}</title>
    <link rel="icon" href="https://raw.githubusercontent.com/dilusha034/FileStreamBot/main/photo_2025-09-24_00-54-09.jpg?v=2" type="image/x-icon">
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <link rel="stylesheet" href="https://unpkg.com/sheryjs/dist/Shery.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/proavipatil/data@main/fs/src/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <nav>
        <div class="nleft"><a href="#"><h3 id="heading" class="magnet title">POP Tv One</h3></a></div>
        <div class="nryt"><a class="home-btn magnet" href="#main">මුල් පිටුව</a><a href="#abtus" class="about-btn magnet">අපි ගැන</a></div>
    </nav>
    <div class="main" id="main" style="padding: 20px;">
        <video id="player" playsinline controls data-filename="{{file_name}}" data-fileurl="{{dl_url}}"></video>
        <div class="file-name">
            <h4>ගොනුවේ නම: {{file_name}}</h4>
            <h4>ගොනුවේ ප්‍රමාණය: {{file_size}}</h4>
        </div>
        <div class="downloadBtn">
            <a href="{{dl_url}}" target="_blank" class="magnet" rel="noopener noreferrer" download="{{file_name}}">
                <button><img style="height: 30px;" src="https://i.ibb.co/RjzYttX/dl.png" alt=""> බාගත කරන්න</button>
            </a>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.155.0/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/automat/controlkit.js@master/bin/controlKit.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sheryjs/dist/Shery.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/proavipatil/data@main/fs/src/script.js"></script>
    <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const videoElement = document.getElementById('player');
                if (!videoElement) return;

                const fileName = videoElement.getAttribute('data-filename');
                const fileUrl = videoElement.getAttribute('data-fileurl');
                if (!fileName || !fileUrl) return;

                const player = new Plyr(videoElement, {
                    captions: { active: true, update: true, language: 'auto' }
                });

                player.source = {
                    type: 'video',
                    title: fileName,
                    sources: [{ src: fileUrl }],
                };

                if (fileName.toLowerCase().endsWith('.mkv')) {
                    const pathParts = window.location.pathname.split('/');
                    const db_id = pathParts[pathParts.length - 1];
                    const response = await fetch(`/subtitles/${db_id}`);
                    
                    if (response.ok) {
                        const subtitleStreams = await response.json();
                        if (subtitleStreams && subtitleStreams.length > 0) {
                            const tracks = subtitleStreams
                                .filter(s => s.codec_type === 'subtitle')
                                .map(s => ({
                                    kind: 'subtitles',
                                    label: s.tags?.title || s.tags?.language || `Track ${s.index}`,
                                    srclang: s.tags?.language?.substring(0, 2) || 'zxx',
                                    src: `/subtitle/${db_id}/${s.index}`,
                                }));
                            
                            // This is a workaround for a Plyr bug where tracks need to be added dynamically after source is set
                            player.once('ready', () => {
                                tracks.forEach(track => {
                                    const trackElement = document.createElement('track');
                                    trackElement.kind = track.kind;
                                    trackElement.label = track.label;
                                    trackElement.srclang = track.srclang;
                                    trackElement.src = track.src;
                                    videoElement.appendChild(trackElement);
                                });
                                // Activate the first subtitle track by default after a short delay
                                if(tracks.length > 0){
                                    setTimeout(() => { 
                                        player.currentTrack = 0; 
                                        player.captions.enabled = true;
                                    }, 500);
                                }
                            });
                        }
                    }
                }
            } catch (error) {
                console.error("Player initialization failed:", error);
            }
        });
    </script>
</body>
</html>
