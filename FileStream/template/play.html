<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POP Tv One | {{file_name}}</title>
    
    <!-- === අත්‍යවශ්‍යම දේ පමණක් ඉතිරි කර ඇත === -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/proavipatil/data@main/fs/src/plyr.css">
    <style>
        body { background-color: #121212; color: white; font-family: sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: auto; }
        .file-info { margin-top: 20px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>{{file_name}}</h1>

        <!-- === අපගේ අවසාන නිවැරදි කිරීම සමඟින් Video Tag එක === -->
        <video id="player" class="player" playsinline controls width="100%" data-filename="{{file_name}}" data-fileurl="{{file_url}}"></video>
        
        <div class="file-info">
            <p>ගොනුවේ ප්‍රමාණය: {{file_size}}</p>
        </div>
    </div>

    <!-- === Plyr.js நூலகය සහ අපගේ අවසන් වරට නිවැරදි කළ Script එක === -->
    <script src="https://cdn.plyr.io/3.6.9/plyr.js"></script>
    <!-- FileStream/template/play.html ගොනුවේ ඇති සම්පූර්ණ <script>...</script> කොටස මකා, මෙය යොදන්න -->

<script>
    async function initializePlayer() {
        try {
            const videoElement = document.getElementById('player');
            if (!videoElement) { console.error("Video element not found."); return; }

            const fileName = videoElement.getAttribute('data-filename');
            const fileUrl = videoElement.getAttribute('data-fileurl');
            if (!fileName || !fileUrl) { console.error("File metadata not found."); return; }

            // --- මෙතන තමයි player විචල්‍යය නිර්මාණය වෙන්නේ ---
            const player = new Plyr(videoElement, {
                captions: { active: true, update: true, language: 'auto' }
            });

            const tracks = [];
            if (fileName.toLowerCase().endsWith('.mkv')) {
                try {
                    const pathParts = window.location.pathname.split('/');
                    const db_id = pathParts[pathParts.length - 1];
                    const subtitleListUrl = `/subtitles/${db_id}`;
                    const response = await fetch(subtitleListUrl);

                    if (response.ok) {
                        const subtitleStreams = await response.json();
                        if (subtitleStreams && Array.isArray(subtitleStreams) && subtitleStreams.length > 0) {
                            console.log(`${subtitleStreams.length} උපසිරැසි පථ සොයාගන්නා ලදී.`);
                            subtitleStreams.forEach((stream, index) => {
                                const subtitleUrl = `/subtitle/${db_id}/${stream.index}`;
                                tracks.push({
                                    kind: 'subtitles',
                                    label: stream.tags?.title || stream.tags?.language || `Subtitle ${index + 1}`,
                                    srclang: stream.tags?.language?.substring(0, 2) || `en${index}`,
                                    src: subtitleUrl,
                                    default: index === 0
                                });
                            });
                        }
                    }
                } catch (error) { console.error("Error fetching subtitles:", error); }
            }
            
            player.source = {
                type: 'video',
                title: fileName,
                sources: [{ src: fileUrl }],
                tracks: tracks
            };

          // player.source එකට පසුව, නමුත් initializePlayer function එක ඇතුළතම
            player.on('languagechange', () => {
    setTimeout(() => {
        try {
            if (player.captions.active && player.captions.ui.buttons.language) {
                player.captions.ui.buttons.language.value = player.captions.language;
            }
        } catch (e) {
        }
    }, 50);
});

        } catch (error) { console.error("A critical error occurred in initializePlayer:", error); }
    }

    document.addEventListener('DOMContentLoaded', () => {
        if (typeof Plyr !== 'undefined') {
            initializePlayer();
        } else {
            console.error('Plyr.js is not loaded.');
        }
    });
</script>
</html>
