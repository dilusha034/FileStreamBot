<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POP Tv One | {{file_name}}</title>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <style>
        :root { --plyr-color-main: #e83a53; }
        body { background-color: #121212; color: white; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 95vh; margin: 0; }
        .container { max-width: 900px; width: 100%; }
        h1 { font-size: 1.5em; margin-bottom: 20px; }
        .file-info { margin-top: 15px; font-size: 0.9em; color: #aaa; }
    </style>
</head>
<body>
    <div class="container">
        <h1>{{file_name}}</h1>
        <video id="player" playsinline controls data-filename="{{file_name}}" data-fileurl="{{file_url}}"></video>
        <div class="file-info">
            <p>ගොනුවේ ප්‍රමාණය: {{file_size}}</p>
        </div>
    </div>

    <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const videoElement = document.getElementById('player');
                if (!videoElement) return;

                const fileName = videoElement.getAttribute('data-filename');
                const fileUrl = videoElement.getAttribute('data-fileurl');
                if (!fileName || !fileUrl) return;

                const player = new Plyr(videoElement, {
                    captions: { active: true, update: true }
                });

                if (fileName.toLowerCase().endsWith('.mkv')) {
                    const pathParts = window.location.pathname.split('/');
                    const db_id = pathParts[pathParts.length - 1];
                    const response = await fetch(`/subtitles/${db_id}`);
                    
                    if (response.ok) {
                        const subtitleStreams = await response.json();
                        if (subtitleStreams && subtitleStreams.length > 0) {
                            console.log(`${subtitleStreams.length} උපසිරැසි පථ සොයාගන්නා ලදී.`);
                            const tracks = subtitleStreams
                                .filter(s => s.codec_type === 'subtitle')
                                .map(s => ({
                                    kind: 'subtitles',
                                    label: s.tags?.title || s.tags?.language || `Track ${s.index}`,
                                    srclang: s.tags?.language?.substring(0, 2) || 'zxx',
                                    src: `/subtitle/${db_id}/${s.index}`,
                                    default: false
                                }));
                            
                            // Dynamically update the player's source with the fetched tracks
                            player.source = {
                                type: 'video',
                                title: fileName,
                                sources: [{ src: fileUrl, type: 'video/mp4' }],
                                tracks: tracks
                            };

                            // Activate the first available subtitle track by default
                            if (tracks.length > 0) {
                                player.once('canplay', () => {
                                   setTimeout(() => { player.currentTrack = 0; }, 100);
                                });
                            }
                        }
                    }
                } else {
                     player.source = {
                        type: 'video',
                        title: fileName,
                        sources: [{ src: fileUrl, type: 'video/mp4' }]
                    };
                }
            } catch (error) {
                console.error("Player initialization failed:", error);
            }
        });
    </script>
</body>
</html>
